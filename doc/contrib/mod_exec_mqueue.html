<html>
<head>
<title>ProFTPD module mod_exec_mqueue</title>
</head>

<body bgcolor=white>

<hr><br>
<center>
<h2><b>ProFTPD module <code>mod_exec_mqueue</code></b></h2>
</center>
<hr><br>

This module is contained in the <code>mod_exec_mqueue.c</code> file for
ProFTPD 1.3.<i>x</i>, found
<a href="http://www.castaglia.org/proftpd/">here</a>, and is not compiled by
default.  Installation instructions are discussed
<a href="#Installation">here</a>.

<p>
The <code>mod_exec_mqueue</code> module extends the <code>mod_exec</code>
module by allowing it to send messages via kernel IPC message queues instead
of executing a script.  Unlike mod_exec running scripts, this module
<em>will</em> work properly for <code>&lt;Anonymous&gt;</code> logins, or for
logins that are affected by <code>DefaultRoot</code>.  This is because the SysV
IPC does not depend on the filesystem at all, and only requires kernel
syscalls.  Of course, it also requires a program to be listening for the
messages on the other end, but that is beyond the scope of this module.

<p>
Please read the <a href="#Usage">usage</a> section to know the other caveats
with this module.

<p>
The most current version of <code>mod_exec_mqueue</code> is distributed with the
ProFTPD source code.

<h2>Author</h2>
<p>
Please contact TJ Saunders &lt;tj <i>at</i> castaglia.org&gt; with any
questions, concerns, or suggestions regarding this module.

<h2>Directives</h2>
<ul>
  <li><a href="#ExecMqueueKey">ExecMqueueKey</a>
  <li><a href="#ExecMqueueType">ExecMqueueType</a>
  <li><a href="#ExecMqueueFormat">ExecMqueueFormat</a>
  <li><a href="#ExecMqueueTimeout">ExecMqueueTimeout</a>
  <li><a href="#ExecMqueueCleanup">ExecMqueueTimeout</a>
  <li><a href="mod_exec.html#ExecLog">ExecLog</a> (from mod_exec)
</ul>

<p>
It also modifies the syntax of the following commands from </code>mod_exec
</code>.  Please read the <a href="#Sending Messages">Sending Messages</a>
section for details.

<p>
<ul>
  <li>ExecBeforeCommand
  <li>ExecOnCommand
  <li>ExecOnConnect
  <li>ExecOnError
  <li>ExecOnEvent
  <li>ExecOnExit
  <li>ExecOnRestart
</ul>

<p>
<hr>
<h2><a name="ExecMqueueKey">ExecMqueueKey</a></h2>
<strong>Syntax:</strong> ExecMqueueKey <em>key value</em><br>
<strong>Default:</strong> None<br>
<strong>Context:</strong> &quot;server config&quot; <code>&lt;VirtualHost&gt;</code>, <code>&lt;Global&gt;</code><br>
<strong>Module:</strong> mod_exec_mqueue<br>
<strong>Compatibility:</strong> 1.3.4rc2 and later

<p>
The <code>ExecMqueueKey</code> directive is used to define the message queue
used to send event messages.  Each server instance may use its own key, but the
key is global to all messages send by that server instance.  The key is a
signed 32-bit integer, and can be provided in either decimal or hexadecimal
form (the latter prefixed with '0x').

<p>
<hr>
<h2><a name="ExecMqueueType">ExecMqueueType</a></h2>
<strong>Syntax:</strong> ExecMqueueType <em>message type</em><br>
<strong>Default:</strong> 1<br>
<strong>Context:</strong> &quot;server config&quot; <code>&lt;VirtualHost&gt;</code>, <code>&lt;Global&gt;</code>, <code>&lt;Anonymous&gt;</code>, <code>&lt;Directory&gt;</code><br>
<strong>Module:</strong> mod_exec_mqueue<br>
<strong>Compatibility:</strong> 1.3.4rc2 and later

<p>
The <code>ExecMqueueType</code> directive is used to define the message type
specified for messages sent in the listed context.  It is a positive long
integer, and can be provided in either decimal or hexadecimal form (the latter
prefixed with '0x').  If not provided, the message type of 1 is used.

<p>
<hr>
<h2><a name="ExecMqueueFormat">ExecMqueueFormat</a></h2>
<strong>Syntax:</strong> ExecMqueueFormat <em>"raw"|"ncftpd"</em><br>
<strong>Default:</strong> "raw"<br>
<strong>Context:</strong> &quot;server config&quot; <code>&lt;VirtualHost&gt;</code>, <code>&lt;Global&gt;</code><br>
<strong>Module:</strong> mod_exec_mqueue<br>
<strong>Compatibility:</strong> 1.3.4rc2 and later

<p>
The <code>ExecMqueueFormat</code> directive is used to specify the format of
the messages sent.  The default format, "raw", simply inserts newlines after
every argument and sends the concatenated string as is.  The "ncftpd" format
uses the same message format as used by NcFTPd, which prepends a header that
also includes the length of the message.  Please read the <a href="#Formats">
Formats</a> section to know more about the message formats.

<p>
<hr>
<h2><a name="ExecMqueueTimeout">ExecMqueueTimeout</a></h2>
<strong>Syntax:</strong> ExecMqueueTimeout <em>seconds</em><br>
<strong>Default:</strong> None<br>
<strong>Context:</strong> &quot;server config&quot; <code>&lt;VirtualHost&gt;</code>, <code>&lt;Global&gt;</code><br>
<strong>Module:</strong> mod_exec_mqueue<br>
<strong>Compatibility:</strong> 1.3.4rc2 and later

<p>
The <code>ExecMqueueTimeout</code> directive is used to set a limit on how long
the msgsnd syscall will block if the message queue is full before it is
interrupted and the message send fails.  Messages that are not sent because of
this are lost, and will not be re-attempted.  Please note that if the message
does block, the user's FTP session will hang until this timeout is exceeded;
if not set the session will hang forever until the server process is killed or
the msgsnd syscall finally returns once the queue is cleared or removed.

<p>
<hr>
<h2><a name="ExecMqueueCleanuop">ExecMqueueCleanuop</a></h2>
<strong>Syntax:</strong> ExecMqueueCleanuop <em>on|off</em><br>
<strong>Default:</strong> on<br>
<strong>Context:</strong> &quot;server config&quot;, <code>&lt;VirtualHost&gt;</code>, <code>&lt;Global&gt;</code><br>
<strong>Module:</strong> mod_exec_mqueue<br>
<strong>Compatibility:</strong> 1.3.4rc2 and later

The <code>ExecMqueueCleanup</code> directive is used to indicate whether the
IPC message queue should be removed when the server shuts down or not.  By
default the queue will be remove; set this to off to leave the messsage queue
in place.  Note that any unread messages will be lost when the queue is
destroyed!

<p>
<hr>
<h2><a name="Usage">Usage</a></h2>
Example configuration:
<pre>
  &lt;IfModule mod_exec_mqueue.c&gt;
    ExecMqueueKey 0xDEADBEEF
    ExecMqueueType 3
    ExecMqueueFormat ncftpd
    ExecMqueueTimeout 30
  &lt;/IfModule&gt;
</pre>

<p>
<hr>
<h2><a name="Formats">Formats</a></h2>
To create the message, each argument will be parsed to replace any "cookies"
(see the <a href="mod_exec.html#ExecEnviron">ExecEnviron</a> directive in
<code>mod_exec</code>) and have a newline appended to it.  The resulting
strings are concatenated in order to produce the raw message string.  If the
format "ncftpd" is selected, the message is prepended with the string,
"STR\n###\n", where "###" is the length of the raw message in bytes, with
leading spaces if less than 100.  This means that ncftpd format messages can
be no longer than 999 characters including the trailing newline.

If you do not want a newline between parameters, instead of separate
arguments you can use a single argument enclosed in quotes, which will only
have a single newline appended at the end.

<p>
<hr>
<h2><a name="Sending Messages">Sending Messages</a></h2>
To use the message queue functionality within mod_exec, the script path
parameter should be replaced by the string "mqueue:", with an optional message
type (see <a href="#ExecMqueueType">ExecMqueueType</a>) immediately following
the ':' character (no spaces in between).  All arguments after that will be
formated as above and then sent via the configured message queue.  The default
maximum message size is 1016 bytes, including the terminating NULL byte -
changing this requires updating and recompiling the source.

Additionally, the '*' and '~' flags to the <a href="mod_exec.html#ExecOnEvent">
ExecOnEvent</a> directive are explicitly ignored, as they are not relevant to
sending messages via IPC.  If these flags are relevant to how the messages are
handled by the receiving software, you will need to incorporate them into the
message itself.
<p>
<hr>
<h2><a name="Installation">Installation</a></h2>
To install <code>mod_exec_mqueue</code>, copy the <code>mod_exec_mqueue.c</code> file into
<pre>
  <i>proftpd-dir</i>/contrib/
</pre>
after unpacking the latest proftpd-1.3.<i>x</i> source code.  Then follow the
usual steps for using third-party modules in proftpd:
<pre>
  ./configure --with-modules=mod_exec_mqueue
</pre>
To build <code>mod_exec_mqueue</code> as a DSO module:
<pre>
  ./configure --enable-dso --with-shared=mod_exec_mqueue
</pre>
Then follow the usual steps:
<pre>
  make
  make install
</pre>

<p>
Alternatively, if your proftpd was compiled with DSO support, you can
use the <code>prxs</code> tool to build <code>mod_exec_mqueue</code> as a shared
module:
<pre>
  prxs -c -i -d mod_exec_mqueue.c
</pre>

<p><a name="FAQ"></a>
<b>Frequently Asked Questions</b><br>
<font color=red>Question</font>: <br>
<font color=blue>Answer</font>: 

<p>
<hr><br>

<font size=2><b><i>
&copy; Copyright 2018 Joshua Megerman<br>
 All Rights Reserved<br>
</i></b></font>

<hr><br>

</body>
</html>

